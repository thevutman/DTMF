<!DOCTYPE html>
<html>
<head>
    <title>Visualizador DTMF</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">
    <style>
        body { margin: 0; overflow: hidden; background: #05050a; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script>
        const socket = io();

        let estadoActual = 0; // 0 intro, 1 reunir, 2 foto, 3 final, 4 fuegos, 5 collage
        let fotoMostrada = null;
        let stickers = [];
        let shakeMagnitude = 0;
        let fireworks = [];
        let introPulses = [];
        let musicaFondo;
        const stickerImages = {};
        let toneColors = {};
        let smileTimer = 0;
        let selfieCompleteBanner = 0;
        let selfieEntries = [];
        let pulsePhase = 0;
        const STICKER_SIZE = 160;

        function preload() {
            stickerImages['base'] = loadImage('../assets/palmera.png');
            musicaFondo = loadSound('../assets/sonido/cancion.mp3');
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);
            imageMode(CENTER);
            textAlign(CENTER, CENTER);
            textFont('Poppins');
            toneColors = {
                'D': color(241, 91, 181),
                'T': color(0, 187, 249),
                'M': color(0, 245, 212),
                'F': color(254, 228, 64)
            };
        }

        function draw() {
            background(5, 5, 15);

            switch (estadoActual) {
                case 0:
                    drawIntroScene();
                    break;
                case 1:
                    drawGatherScene();
                    break;
                case 2:
                    drawPhotoScene(false);
                    break;
                case 3:
                    drawPhotoScene(true);
                    break;
                case 4:
                    drawFireworksScene();
                    break;
                case 5:
                    drawSelfieCollage();
                    break;
            }

            if (smileTimer > 0) {
                drawSmileOverlay();
                smileTimer--;
            }
            if (selfieCompleteBanner > 0) {
                drawSelfieCompleteOverlay();
                selfieCompleteBanner--;
            }
        }

        function drawIntroScene() {
            pulsePhase += 0.004;
            noStroke();
            for (let i = 0; i < height; i += 6) {
                const alpha = map(Math.sin(pulsePhase * 3 + i * 0.008), -1, 1, 20, 80);
                fill(10, 12, 40, alpha);
                rect(0, i, width, 6);
            }

            stroke(255, 32);
            for (let i = 0; i <= 10; i++) {
                const offset = Math.sin(pulsePhase * 6 + i * 0.4) * 60;
                line((width / 10) * i + offset, 0, (width / 10) * i - offset, height);
            }

            for (let i = introPulses.length - 1; i >= 0; i--) {
                introPulses[i].update();
                introPulses[i].show();
                if (introPulses[i].isFinished()) {
                    introPulses.splice(i, 1);
                }
            }

            fill(255);
            textSize(width < 900 ? 54 : 80);
            text('BAD BUNNY · DTMF', width / 2, height * 0.28);
            textSize(width < 900 ? 36 : 48);
            text('AUDIENCIA EN CONTROL', width / 2, height * 0.4);

            fill(200, 200, 255, 190);
            textSize(width < 900 ? 22 : 28);
            text('Golpea tu pantalla para mandar tonos y encender la tarima', width / 2, height * 0.72);
            textSize(width < 900 ? 18 : 24);
            text('Cada tono aparece como una letra D · T · M · F en la pantalla', width / 2, height * 0.8);
        }

        function drawGatherScene() {
            drawGradientBackground();
            fill(255);
            textSize(width < 900 ? 52 : 68);
            text('Junten todos para la foto', width / 2, height * 0.38);
            fill(180, 180, 255, 180);
            textSize(width < 900 ? 24 : 30);
            text('El staff está alineando la toma. Móviles listos.', width / 2, height * 0.52);
        }

        function drawPhotoScene(isFinal) {
            drawGradientBackground();
            if (fotoMostrada) {
                push();
                const ratio = fotoMostrada.width / fotoMostrada.height;
                const canvasRatio = width / height;
                let drawWidth, drawHeight;
                if (ratio > canvasRatio) {
                    drawWidth = width;
                    drawHeight = width / ratio;
                } else {
                    drawHeight = height;
                    drawWidth = height * ratio;
                }
                image(fotoMostrada, width / 2, height / 2, drawWidth, drawHeight);
                pop();
            }

            stickers.forEach(sticker => {
                const stickerImg = stickerImages['base'];
                if (!stickerImg) return;
                const sx = sticker.x * width;
                const sy = sticker.y * height;
                const toneColor = toneColors[sticker.tone] || color(255);
                push();
                imageMode(CENTER);
                tint(red(toneColor), green(toneColor), blue(toneColor), 240);
                image(stickerImg, sx, sy, STICKER_SIZE, STICKER_SIZE);
                noTint();
                pop();
            });

            if (!isFinal && shakeMagnitude > 0) {
                push();
                noStroke();
                fill(255, 255, 255, 90);
                ellipse(width / 2, height / 2, shakeMagnitude * 18);
                shakeMagnitude *= 0.9;
                pop();
            }

            if (isFinal) {
                fill(10, 10, 15, 180);
                rect(0, height * 0.82, width, height * 0.18);
                fill(255);
                textSize(width < 900 ? 30 : 40);
                text('Memoria DTMF lista para descargar', width / 2, height * 0.9);
            }
        }

        function drawFireworksScene() {
            drawGradientBackground();
            fill(255);
            textSize(width < 900 ? 56 : 74);
            text('¡LANZA LOS PETARDOS!', width / 2, height * 0.24);
            textSize(width < 900 ? 26 : 34);
            fill(200, 200, 255, 190);
            text('Levanta los móviles cuando el beat caiga', width / 2, height * 0.32);

            const gravity = createVector(0, 0.22);
            for (let i = fireworks.length - 1; i >= 0; i--) {
                if (!fireworks[i].exploded) {
                    fireworks[i].applyForce(gravity);
                }
                fireworks[i].update();
                fireworks[i].show();
                if (fireworks[i].isFinished()) {
                    fireworks.splice(i, 1);
                }
            }
        }

        function drawSelfieCollage() {
            pulsePhase += 0.0035;
            drawGradientBackground();

            noStroke();
            for (let i = 0; i < 8; i++) {
                const alpha = map(Math.sin(pulsePhase * 2 + i * 0.6), -1, 1, 18, 90);
                fill(241, 91, 181, alpha);
                const w = width * (0.9 - i * 0.06);
                const h = height * 0.18;
                ellipse(width / 2, height * (0.12 + i * 0.04), w, h);
            }

            fill(255);
            textSize(width < 900 ? 46 : 60);
            text('COLLAGE TRIBU DTMF', width / 2, height * 0.18);
            fill(190, 200, 255, 200);
            textSize(width < 900 ? 22 : 28);
            text('Envíen sus selfies para aparecer en la pantalla gigante.', width / 2, height * 0.26);

            if (selfieEntries.length === 0) {
                fill(200, 200, 255, 180);
                textSize(width < 900 ? 24 : 32);
                text('Aún no hay selfies. Levanten sus móviles y capturen la vibra.', width / 2, height * 0.56);
                return;
            }

            selfieEntries.forEach((entry) => {
                if (!entry.img) return;
                push();
                translate(entry.posX, entry.posY);
                rotate(entry.angle || 0);
                rectMode(CENTER);
                const ratio = entry.img.width / entry.img.height;
                let drawWidth = entry.cellWidth;
                let drawHeight = drawWidth / ratio;
                if (drawHeight > entry.cellHeight) {
                    drawHeight = entry.cellHeight;
                    drawWidth = drawHeight * ratio;
                }
                fill(5, 5, 20, 210);
                rect(0, 0, drawWidth + 26, drawHeight + 26, 22);
                stroke(241, 91, 181, 160);
                strokeWeight(4);
                noFill();
                rect(0, 0, drawWidth + 26, drawHeight + 26, 22);
                imageMode(CENTER);
                noStroke();
                image(entry.img, 0, 0, drawWidth, drawHeight);
                pop();
            });

            fill(255, 255, 255, 120);
            textSize(width < 900 ? 18 : 22);
            text('Cuando el staff lo indique, daremos paso a la foto grupal.', width / 2, height * 0.9);
        }

        function drawGradientBackground() {
            noFill();
            for (let y = 0; y <= height; y += 4) {
                const lerpVal = map(y, 0, height, 0, 1);
                const c1 = color(15, 10, 40);
                const c2 = color(5, 5, 15);
                const c = lerpColor(c1, c2, lerpVal);
                stroke(c);
                line(0, y, width, y);
            }
        }

        function drawSmileOverlay() {
            push();
            fill(0, 0, 0, 140);
            rect(0, 0, width, height);
            fill(255);
            textSize(width < 900 ? 46 : 62);
            text('¡SONRÍE! LA FOTO VA AHORA', width / 2, height / 2);
            pop();
        }

        function drawSelfieCompleteOverlay() {
            push();
            fill(5, 5, 12, 160);
            rect(0, 0, width, height);
            fill(255);
            textSize(width < 900 ? 44 : 58);
            text('SELFIES LISTAS · PREPAREN LA SONRISA', width / 2, height / 2);
            pop();
        }

        class IntroPulse {
            constructor({ tone, intensity, mobileId }) {
                this.x = random(width * 0.2, width * 0.8);
                this.y = random(height * 0.25, height * 0.8);
                this.radius = 40;
                this.growth = map(intensity || 1, 0.4, 1.6, 10, 26);
                this.alpha = 255;
                this.tone = tone || 'D';
                this.mobileId = mobileId;
                this.color = toneColors[this.tone] || color(255);
            }

            update() {
                this.radius += this.growth;
                this.alpha -= 4;
            }

            show() {
                push();
                stroke(red(this.color), green(this.color), blue(this.color), this.alpha);
                strokeWeight(4);
                noFill();
                ellipse(this.x, this.y, this.radius * 2);
                fill(red(this.color), green(this.color), blue(this.color), this.alpha);
                noStroke();
                textSize(map(this.radius, 40, 420, 28, 96));
                text(this.tone, this.x, this.y);
                pop();
            }

            isFinished() {
                return this.alpha <= 0;
            }
        }

        class Firework {
            constructor(mobileId, intensity) {
                this.pos = createVector(random(width * 0.2, width * 0.8), height * 0.95);
                this.vel = createVector(random(-1.5, 1.5), random(-16, -22));
                this.acc = createVector(0, 0);
                if (mobileId === 'mobile_a') {
                    this.color = color(241, 91, 181);
                } else {
                    this.color = color(0, 187, 249);
                }
                this.lifespan = 255;
                this.exploded = false;
                this.explosionParticles = [];
                this.intensity = map(intensity, 30, 90, 0.6, 1.5);
            }

            update() {
                if (!this.exploded) {
                    this.vel.add(this.acc);
                    this.pos.add(this.vel);
                    this.acc.mult(0);
                    this.lifespan -= 4;
                    if (this.vel.y > -2 || this.lifespan < 80) {
                        this.explode();
                    }
                } else {
                    for (let i = this.explosionParticles.length - 1; i >= 0; i--) {
                        this.explosionParticles[i].update();
                        if (this.explosionParticles[i].isFinished()) {
                            this.explosionParticles.splice(i, 1);
                        }
                    }
                }
            }

            applyForce(force) {
                this.acc.add(force);
            }

            explode() {
                this.exploded = true;
                const numParticles = Math.floor(random(60, 110) * this.intensity);
                for (let i = 0; i < numParticles; i++) {
                    this.explosionParticles.push(new Particle(this.pos.x, this.pos.y, this.color));
                }
            }

            show() {
                if (!this.exploded) {
                    stroke(this.color);
                    strokeWeight(4);
                    point(this.pos.x, this.pos.y);
                } else {
                    for (const particle of this.explosionParticles) {
                        particle.show();
                    }
                }
            }

            isFinished() {
                return this.exploded && this.explosionParticles.length === 0;
            }
        }

        class Particle {
            constructor(x, y, colorIn) {
                this.pos = createVector(x, y);
                this.vel = p5.Vector.random2D();
                this.vel.mult(random(2, 9));
                this.lifespan = 255;
                this.color = colorIn;
            }

            update() {
                this.vel.mult(0.94);
                this.pos.add(this.vel);
                this.lifespan -= 5;
            }

            show() {
                noStroke();
                fill(red(this.color), green(this.color), blue(this.color), this.lifespan);
                ellipse(this.pos.x, this.pos.y, 4, 4);
            }

            isFinished() {
                return this.lifespan <= 0;
            }
        }

        function updateSelfieEntries(list = []) {
            const incoming = list.map((item, index) => ({
                mobileId: item.mobileId || `mobile_${index}`,
                image: item.image
            })).filter(item => !!item.image);

            const ids = new Set(incoming.map(item => item.mobileId));
            selfieEntries = selfieEntries.filter(entry => ids.has(entry.mobileId));

            incoming.forEach((item) => {
                let entry = selfieEntries.find((e) => e.mobileId === item.mobileId);
                if (!entry) {
                    entry = {
                        mobileId: item.mobileId,
                        src: item.image,
                        img: null,
                        angle: random(-0.12, 0.12)
                    };
                    selfieEntries.push(entry);
                }

                if (entry.src !== item.image) {
                    entry.src = item.image;
                    entry.img = null;
                }

                if (!entry.img) {
                    loadImage(item.image, (img) => {
                        entry.img = img;
                        prepareSelfieLayout();
                    });
                }
            });

            prepareSelfieLayout();
        }

        function prepareSelfieLayout() {
            if (selfieEntries.length === 0) return;

            const cols = Math.ceil(Math.sqrt(selfieEntries.length));
            const rows = Math.ceil(selfieEntries.length / cols);
            const collageWidth = width * 0.78;
            const collageHeight = height * 0.58;
            const startX = (width - collageWidth) / 2;
            const startY = height * 0.34;
            const cellWidth = collageWidth / cols;
            const cellHeight = collageHeight / rows;

            selfieEntries.forEach((entry, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                entry.posX = startX + col * cellWidth + cellWidth / 2;
                entry.posY = startY + row * cellHeight + cellHeight / 2;
                entry.cellWidth = cellWidth * 0.82;
                entry.cellHeight = cellHeight * 0.82;
                if (typeof entry.angle === 'undefined') {
                    entry.angle = random(-0.12, 0.12);
                }
            });
        }

        socket.on('escena_1_intro', () => {
            console.log('Visual: escena 1 (intro) activada.');
            estadoActual = 0;
            introPulses = [];
            fireworks = [];
            stickers = [];
            fotoMostrada = null;
            selfieEntries = [];
            selfieCompleteBanner = 0;
        });

        socket.on('pulso_dtmf_visual', (data) => {
            if (estadoActual === 0) {
                introPulses.push(new IntroPulse(data));
            }
        });

        socket.on('iniciar_collage_selfies', () => {
            console.log('Visual: collage de selfies activado.');
            estadoActual = 5;
            introPulses = [];
            fireworks = [];
            stickers = [];
            fotoMostrada = null;
            selfieEntries = [];
            selfieCompleteBanner = 0;
        });

        socket.on('selfies_actualizadas', (list = []) => {
            if (estadoActual === 5) {
                updateSelfieEntries(list);
            }
        });

        socket.on('selfie_stage_completa', () => {
            if (estadoActual === 5) {
                selfieCompleteBanner = 220;
            }
        });

        socket.on('cambiar_a_escena_3', () => {
            console.log('Visual: escena 3 (pre foto) activada.');
            estadoActual = 1;
            introPulses = [];
            selfieCompleteBanner = 0;
        });

        socket.on('mostrar_foto', (imageData) => {
            console.log('Visual: foto recibida. Escena 2.');
            estadoActual = 2;
            stickers = [];
            loadImage(imageData, (img) => {
                fotoMostrada = img;
            });
        });

        socket.on('agregar_sticker_visualizador', (stickerData) => {
            stickers.push(stickerData);
        });

        socket.on('efecto_maraca', (data) => {
            const magnitude = Math.sqrt(data.x * data.x + data.y * data.y + data.z * data.z);
            shakeMagnitude = magnitude;
        });

        socket.on('mostrar_foto_final', (data) => {
            console.log('Visual: foto final lista.');
            estadoActual = 3;
            if (data) {
                loadImage(data.foto, (img) => {
                    fotoMostrada = img;
                });
                stickers = data.stickers || stickers;
            }
        });

        socket.on('cambiar_a_escena_4', () => {
            console.log('Visual: escena 2 (fuegos) activada.');
            estadoActual = 4;
            fireworks = [];
        });

        socket.on('mostrar_fuego_artificial', (data) => {
            if (estadoActual === 4) {
                fireworks.push(new Firework(data.mobileId, data.intensity));
            }
        });

        socket.on('control_musica_visualizador', (action) => {
            if (musicaFondo.isLoaded()) {
                if (action === 'play' && !musicaFondo.isPlaying()) {
                    musicaFondo.loop();
                } else if (action === 'pause' && musicaFondo.isPlaying()) {
                    musicaFondo.pause();
                } else if (action === 'forward') {
                    const newTime = musicaFondo.currentTime() + 10;
                    if (newTime < musicaFondo.duration()) {
                        musicaFondo.jump(newTime);
                    }
                }
            }
        });

        socket.on('mostrar_gif_sonrie', () => {
            smileTimer = 240;
        });

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            prepareSelfieLayout();
        }
    </script>
</body>
</html>
